<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‘¨ç¹æ¼ªAIäººè„¸èåˆ - å¾®ä¿¡ç‰ˆ</title>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .back-btn {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
        }

        .header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .template-preview {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }

        .template-image {
            width: 120px;
            height: 160px;
            border-radius: 12px;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        .template-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .upload-section {
            padding: 20px;
            text-align: center;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-area.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-icon {
            font-size: 48px;
            color: #ddd;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 16px;
            color: #666;
            margin-bottom: 8px;
        }

        .upload-hint {
            font-size: 14px;
            color: #999;
        }

        .preview-image {
            display: block;
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin: 0 auto 20px auto;
            object-fit: contain;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #ddd;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .result-section {
            padding: 20px;
            text-align: center;
            display: none;
        }

        .result-image {
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-message {
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }

        .status-success {
            background: #e8f7f0;
            color: #27ae60;
        }

        .status-error {
            background: #fdedec;
            color: #e74c3c;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-btn" onclick="goBack()">â† è¿”å›</button>
            <h1>ğŸ­ å‘¨ç¹æ¼ªAIäººè„¸èåˆ</h1>
            <p>å¾®ä¿¡ä¸“äº«ç‰ˆ - æ‹ç…§èåˆåˆ†äº«</p>
        </div>

        <div class="template-preview">
            <img id="templateImage" class="template-image" src="" alt="æ¨¡æ¿é¢„è§ˆ">
            <div id="templateName" class="template-name">åŠ è½½ä¸­...</div>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“·</div>
                <div class="upload-text">ç‚¹å‡»æ‹ç…§æˆ–é€‰æ‹©ç…§ç‰‡</div>
                <div class="upload-hint">æ”¯æŒå¾®ä¿¡æ‹ç…§å’Œç›¸å†Œé€‰æ‹©</div>
            </div>

            <img id="previewImage" class="preview-image hidden" src="" alt="é¢„è§ˆ">

            <div class="action-buttons">
                <button class="btn btn-secondary" id="retakeBtn" onclick="retakePhoto()" style="display: none;">é‡æ–°æ‹ç…§</button>
                <button class="btn btn-primary" id="fusionBtn" onclick="startFusion()" disabled>ğŸ¨ å¼€å§‹èåˆ</button>
            </div>

            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <div>AIæ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</div>
            </div>

            <div class="status-message" id="statusMessage"></div>
        </div>

        <div class="result-section" id="resultSection">
            <h3>ğŸ‰ èåˆå®Œæˆ</h3>
            <img id="resultImage" class="result-image" src="" alt="èåˆç»“æœ">
            
            <div class="share-buttons">
                <button class="btn btn-primary" onclick="saveToAlbum()">é•¿æŒ‰å›¾ç‰‡ä¿å­˜/åˆ†äº«</button>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="resetApp()">é‡æ–°åˆ¶ä½œ</button>
            </div>
        </div>


    </div>

    <script>
        let currentTemplate = null;
        let userImageUrl = null; // å­˜å‚¨æœ€ç»ˆçš„å›¾ç‰‡URLï¼ˆOSSæˆ–æœ¬åœ°ï¼‰
        let resultImageUrl = null;
        


        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = '') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type ? 'status-' + type : ''}`;
            statusDiv.classList.remove('hidden');

            if (message) {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 3000);
            }
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show) {
            const loading = document.getElementById('loading');
            loading.style.display = show ? 'block' : 'none';
        }

        // æ£€æŸ¥æ˜¯å¦åœ¨å¾®ä¿¡æµè§ˆå™¨ä¸­
        function isWechatBrowser() {
            return /micromessenger/i.test(navigator.userAgent);
        }

        // è·å–URLå‚æ•°
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // åˆå§‹åŒ–é¡µé¢
        async function initPage() {
            console.log('ğŸ“± å¼€å§‹åˆå§‹åŒ–é¡µé¢');

            if (!isWechatBrowser()) {
                showStatus('è¯·åœ¨å¾®ä¿¡ä¸­æ‰“å¼€æ­¤é¡µé¢', 'error');
                return;
            }

            // è·å–æ¨¡æ¿ID
            const templateId = getUrlParameter('template') || '1';
            console.log('ğŸ­ æ¨¡æ¿ID: ' + templateId);

            try {
                // åŠ è½½æ¨¡æ¿ä¿¡æ¯
                const response = await fetch(`/api/template/${templateId}`);
                const result = await response.json();

                if (result.success) {
                    currentTemplate = result.data;
                    document.getElementById('templateImage').src = currentTemplate.thumbnailUrl;
                    document.getElementById('templateName').textContent = currentTemplate.name;
                    console.log('âœ… æ¨¡æ¿åŠ è½½æˆåŠŸ: ' + currentTemplate.name);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('âŒ æ¨¡æ¿åŠ è½½å¤±è´¥: ' + error.message);
                showStatus('æ¨¡æ¿åŠ è½½å¤±è´¥', 'error');
            }
        }

        // åˆå§‹åŒ–å¾®ä¿¡é…ç½® - æŒ‰ç…§ä½ çš„ä¾‹å­ä¿®æ”¹
        async function initWxConfig() {
            console.log('ğŸ“± å¼€å§‹åˆå§‹åŒ–å¾®ä¿¡é…ç½®');

            try {
                // æŒ‰ç…§ä½ çš„ä¾‹å­ä½¿ç”¨GETè¯·æ±‚
                const currentUrl = window.location.href.split('#')[0];
                console.log('ğŸ“ å½“å‰URL: ' + currentUrl);

                const response = await fetch(`/wechat-signature?url=${encodeURIComponent(currentUrl)}`);
                const config = await response.json();

                if (config.error) {
                    throw new Error(config.error);
                }

                console.log('âœ… å¾®ä¿¡é…ç½®è·å–æˆåŠŸ');
                console.log('ğŸ“‹ é…ç½®è¯¦æƒ…: ' + JSON.stringify(config));

                wx.config({
                    debug: false, // å…³é—­è°ƒè¯•æ¨¡å¼
                    appId: config.appId,
                    timestamp: config.timestamp,
                    nonceStr: config.nonceStr,
                    signature: config.signature,
                    jsApiList: [
                        'chooseImage',
                        'uploadImage',
                        'downloadImage',
                        'getLocalImgData',
                        'previewImage'
                    ]
                });

                wx.ready(function() {
                    console.log('âœ… å¾®ä¿¡SDKåˆå§‹åŒ–æˆåŠŸ');
                    showStatus('å¾®ä¿¡åŠŸèƒ½å·²å°±ç»ª', 'success');
                });

                wx.error(function(res) {
                    console.error('âŒ å¾®ä¿¡SDKåˆå§‹åŒ–å¤±è´¥: ' + JSON.stringify(res));

                    // è¯¦ç»†çš„é”™è¯¯åˆ†æ
                    let errorMsg = 'å¾®ä¿¡åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥';
                    if (res.errMsg) {
                        if (res.errMsg.includes('invalid signature')) {
                            errorMsg = 'ç­¾åéªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥åŸŸåé…ç½®';
                        } else if (res.errMsg.includes('invalid url domain')) {
                            errorMsg = 'URLåŸŸåæœªé…ç½®ï¼Œè¯·åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°æ·»åŠ JSæ¥å£å®‰å…¨åŸŸå';
                        } else if (res.errMsg.includes('permission denied')) {
                            errorMsg = 'æƒé™è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥å…¬ä¼—å·æƒé™é…ç½®';
                        }
                    }

                    showStatus(errorMsg, 'error');
                    console.error('ğŸ” é”™è¯¯è¯¦æƒ…: ' + errorMsg);
                });

            } catch (error) {
                console.error('âŒ å¾®ä¿¡é…ç½®å¤±è´¥: ' + error.message);
                showStatus('å¾®ä¿¡é…ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }



        // æ‹ç…§æˆ–é€‰æ‹©ç…§ç‰‡ - æ–°çš„å¤„ç†é€»è¾‘
        function chooseImage() {
            console.log('ğŸ“· ç”¨æˆ·ç‚¹å‡»æ‹ç…§');

            if (typeof wx === 'undefined') {
                showStatus('å¾®ä¿¡SDKæœªåŠ è½½', 'error');
                return;
            }

            wx.chooseImage({
                count: 1,
                sizeType: ['original', 'compressed'],
                sourceType: ['album', 'camera'],
                success: function (res) {
                    const localId = res.localIds[0];
                    console.log('ğŸ“· æ‹ç…§æˆåŠŸï¼ŒlocalId: ' + localId);

                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    showLoading(true);
                    showStatus('æ­£åœ¨å¤„ç†å›¾ç‰‡...', '');

                    // ä¸Šä¼ åˆ°å¾®ä¿¡æœåŠ¡å™¨
                    wx.uploadImage({
                        localId: localId,
                        isShowProgressTips: 0,
                        success: function (uploadRes) {
                            const serverId = uploadRes.serverId;
                            console.log('â¬†ï¸ ä¸Šä¼ æˆåŠŸï¼ŒserverId: ' + serverId);

                            // å…³é”®æ”¹å˜ï¼šç›´æ¥å‘é€serverIdåˆ°æœåŠ¡å™¨å¤„ç†
                            processWechatImage(serverId);
                        },
                        fail: function(err) {
                            showLoading(false);
                            console.error('âŒ ä¸Šä¼ å¤±è´¥: ' + JSON.stringify(err));
                            showStatus('å›¾ç‰‡ä¸Šä¼ å¤±è´¥', 'error');
                        }
                    });
                },
                fail: function(err) {
                    console.error('âŒ é€‰æ‹©å›¾ç‰‡å¤±è´¥: ' + JSON.stringify(err));
                    showStatus('é€‰æ‹©å›¾ç‰‡å¤±è´¥', 'error');
                }
            });
        }

        // å¤„ç†å¾®ä¿¡å›¾ç‰‡ - å‘é€åˆ°æœåŠ¡å™¨ä¸‹è½½å¹¶ä¸Šä¼ åˆ°OSS
        async function processWechatImage(serverId) {
            console.log('ğŸ”„ å¼€å§‹å¤„ç†å¾®ä¿¡å›¾ç‰‡ï¼ŒserverId: ' + serverId);

            try {
                const response = await fetch('/api/wechat/download-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ serverId: serverId })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('âœ… å›¾ç‰‡å¤„ç†æˆåŠŸï¼ŒURL: ' + result.url);

                    // ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„URLæ˜¾ç¤ºå›¾ç‰‡
                    showPreview(result.url);
                    userImageUrl = result.url;

                    showLoading(false);
                    showStatus('å›¾ç‰‡å¤„ç†å®Œæˆï¼', 'success');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showLoading(false);
                console.error('âŒ å›¾ç‰‡å¤„ç†å¤±è´¥: ' + error.message);
                showStatus('å›¾ç‰‡å¤„ç†å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºé¢„è§ˆ - ä½¿ç”¨æœåŠ¡å™¨URL
        function showPreview(imageUrl) {
            console.log('ğŸ–¼ï¸ æ˜¾ç¤ºé¢„è§ˆï¼ŒURL: ' + imageUrl);

            const uploadArea = document.getElementById('uploadArea');
            const previewImage = document.getElementById('previewImage');
            const retakeBtn = document.getElementById('retakeBtn');
            const fusionBtn = document.getElementById('fusionBtn');

            // è®¾ç½®å›¾ç‰‡æº
            previewImage.src = imageUrl;
            previewImage.onload = function() {
                console.log('âœ… é¢„è§ˆå›¾ç‰‡åŠ è½½æˆåŠŸ');

                // æ›´æ–°UI
                uploadArea.style.display = 'none';
                previewImage.classList.remove('hidden');
                retakeBtn.style.display = 'inline-block';
                fusionBtn.disabled = false; // å…³é”®ï¼šå¯ç”¨èåˆæŒ‰é’®

                showStatus('ç…§ç‰‡å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹èåˆäº†ï¼', 'success');
            };

            previewImage.onerror = function() {
                console.error('âŒ é¢„è§ˆå›¾ç‰‡åŠ è½½å¤±è´¥');
                showStatus('å›¾ç‰‡æ˜¾ç¤ºå¤±è´¥', 'error');
            };
        }

        // é‡æ–°æ‹ç…§
        function retakePhoto() {
            console.log('ğŸ”„ ç”¨æˆ·é€‰æ‹©é‡æ–°æ‹ç…§');

            const uploadArea = document.getElementById('uploadArea');
            const previewImage = document.getElementById('previewImage');
            const retakeBtn = document.getElementById('retakeBtn');
            const fusionBtn = document.getElementById('fusionBtn');

            uploadArea.style.display = 'block';
            previewImage.classList.add('hidden');
            retakeBtn.style.display = 'none';
            fusionBtn.disabled = true;
            userImageUrl = null;

            showStatus('', '');
        }

        // å¼€å§‹èåˆ
        async function startFusion() {
            console.log('ğŸ¨ å¼€å§‹äººè„¸èåˆ');

            if (!userImageUrl || !currentTemplate) {
                showStatus('è¯·å…ˆé€‰æ‹©ç…§ç‰‡å’Œæ¨¡æ¿', 'error');
                return;
            }

            showLoading(true);
            showStatus('AIæ­£åœ¨è¿›è¡Œäººè„¸èåˆï¼Œè¯·ç¨å€™...', '');

            try {
                const response = await fetch('/api/face-fusion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userImageUrl: userImageUrl,
                        templateId: currentTemplate.id
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('âœ… äººè„¸èåˆæˆåŠŸ');
                    showResult(result.data.imageUrl || result.data.localImageUrl);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('âŒ äººè„¸èåˆå¤±è´¥: ' + error.message);
                showStatus('èåˆå¤±è´¥: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(imageUrl) {
            console.log('ğŸ‰ æ˜¾ç¤ºèåˆç»“æœ: ' + imageUrl);

            resultImageUrl = imageUrl;

            const uploadSection = document.querySelector('.upload-section');
            const resultSection = document.getElementById('resultSection');
            const resultImage = document.getElementById('resultImage');

            resultImage.src = imageUrl;
            uploadSection.style.display = 'none';
            resultSection.style.display = 'block';

            showStatus('èåˆå®Œæˆï¼', 'success');
        }



        // é•¿æŒ‰å›¾ç‰‡ä¿å­˜/åˆ†äº« - å¾®ä¿¡åŸç”ŸåŠŸèƒ½
        function saveToAlbum() {
            if (!resultImageUrl) {
                showStatus('æ²¡æœ‰å¯ä¿å­˜çš„å›¾ç‰‡', 'error');
                return;
            }

            console.log('ğŸ’¾ æ˜¾ç¤ºå›¾ç‰‡ä¾›ç”¨æˆ·é•¿æŒ‰ä¿å­˜/åˆ†äº«: ' + resultImageUrl);

            // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆï¼Œç”¨æˆ·å¯ä»¥é•¿æŒ‰è¿›è¡Œä¿å­˜æˆ–å‘é€ç»™æœ‹å‹
            showImagePreviewForSave(resultImageUrl);
        }

        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆä¾›ç”¨æˆ·é•¿æŒ‰ä¿å­˜ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆä¾›ç”¨æˆ·é•¿æŒ‰ä¿å­˜ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆä¾›ç”¨æˆ·é•¿æŒ‰ä¿å­˜
        function showImagePreviewForSave(imageUrl) {
            console.log('ğŸ” æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆä¾›ç”¨æˆ·ä¿å­˜: ' + imageUrl);

            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 10000;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                padding: 20px;
            `;

            // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.cssText = `
                max-width: 90%;
                max-height: 70%;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(255,255,255,0.1);
                object-fit: contain;
            `;

            // æ·»åŠ æç¤ºæ–‡å­—
            const hint = document.createElement('div');
            hint.innerHTML = `
                <div style="color: white; font-size: 18px; text-align: center; margin: 20px 0;">
                    ğŸ“± é•¿æŒ‰å›¾ç‰‡è¿›è¡Œæ“ä½œ
                </div>
                <div style="color: #ccc; font-size: 14px; text-align: center; line-height: 1.5;">
                    åœ¨å¾®ä¿¡ä¸­é•¿æŒ‰å›¾ç‰‡å¯ä»¥ï¼š<br>
                    ğŸ’¾ ä¿å­˜å›¾ç‰‡åˆ°æ‰‹æœºç›¸å†Œ<br>
                    ğŸ“¤ å‘é€ç»™æœ‹å‹
                </div>
            `;

            // æ·»åŠ å…³é—­æŒ‰é’®
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'âœ• å…³é—­';
            closeBtn.style.cssText = `
                background: rgba(255,255,255,0.2);
                color: white;
                border: 1px solid rgba(255,255,255,0.3);
                padding: 12px 24px;
                border-radius: 25px;
                margin-top: 20px;
                cursor: pointer;
                font-size: 16px;
                transition: all 0.3s ease;
            `;

            closeBtn.onmouseover = function() {
                this.style.background = 'rgba(255,255,255,0.3)';
            };

            closeBtn.onmouseout = function() {
                this.style.background = 'rgba(255,255,255,0.2)';
            };

            closeBtn.onclick = function() {
                document.body.removeChild(overlay);
                console.log('ğŸ” ç”¨æˆ·å…³é—­äº†å›¾ç‰‡é¢„è§ˆ');
            };

            // ç‚¹å‡»é®ç½©å±‚ä¹Ÿå¯ä»¥å…³é—­
            overlay.onclick = function(e) {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    console.log('ğŸ” ç”¨æˆ·ç‚¹å‡»é®ç½©å…³é—­äº†å›¾ç‰‡é¢„è§ˆ');
                }
            };

            // ç»„è£…å…ƒç´ 
            overlay.appendChild(img);
            overlay.appendChild(hint);
            overlay.appendChild(closeBtn);
            document.body.appendChild(overlay);

            showStatus('è¯·é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œ', 'success');
            console.log('âœ… å›¾ç‰‡é¢„è§ˆå·²æ˜¾ç¤º');
        }

        // é‡ç½®åº”ç”¨
        function resetApp() {
            console.log('ğŸ”„ é‡ç½®åº”ç”¨');

            const uploadSection = document.querySelector('.upload-section');
            const resultSection = document.getElementById('resultSection');

            uploadSection.style.display = 'block';
            resultSection.style.display = 'none';

            retakePhoto();
        }

        // è¿”å›ä¸»é¡µ
        function goBack() {
            window.location.href = '/';
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“± é¡µé¢å¼€å§‹åŠ è½½');

            // åˆå§‹åŒ–é¡µé¢
            initPage();

            // å»¶è¿Ÿåˆå§‹åŒ–å¾®ä¿¡é…ç½®
            setTimeout(() => {
                initWxConfig();
            }, 1000);

            // ç»‘å®šä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
            document.getElementById('uploadArea').addEventListener('click', function() {
                console.log('ğŸ‘† ç”¨æˆ·ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ');
                chooseImage();
            });

            console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>
