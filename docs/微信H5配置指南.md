# ğŸ”§ å¾®ä¿¡H5é…ç½®æŒ‡å—

## ğŸ“‹ é…ç½®æ¸…å•

### 1. å¾®ä¿¡å…¬ä¼—å·é…ç½®

#### å¿…è¦æ¡ä»¶
- âœ… **å·²è®¤è¯çš„å¾®ä¿¡å…¬ä¼—å·** (æœåŠ¡å·æˆ–è®¢é˜…å·)
- âœ… **å·²å¤‡æ¡ˆçš„åŸŸå** (å¿…é¡»æ˜¯HTTPS)
- âœ… **JSæ¥å£å®‰å…¨åŸŸåé…ç½®**

#### é…ç½®æ­¥éª¤
1. ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å° (mp.weixin.qq.com)
2. è¿›å…¥"è®¾ç½®ä¸å¼€å‘" â†’ "å…¬ä¼—å·è®¾ç½®" â†’ "åŠŸèƒ½è®¾ç½®"
3. é…ç½®"JSæ¥å£å®‰å…¨åŸŸå"ï¼Œå¡«å…¥ä½ çš„åŸŸå (å¦‚: your-domain.com)
4. ä¸‹è½½éªŒè¯æ–‡ä»¶å¹¶ä¸Šä¼ åˆ°æœåŠ¡å™¨æ ¹ç›®å½•
5. **é…ç½®IPç™½åå•**ï¼š
   - è¿›å…¥"å¼€å‘" â†’ "åŸºæœ¬é…ç½®"
   - åœ¨"IPç™½åå•"ä¸­æ·»åŠ æœåŠ¡å™¨IP: `124.126.98.47`
   - è¿™æ˜¯å¿…é¡»æ­¥éª¤ï¼Œå¦åˆ™æ— æ³•è·å–access_token

### 2. ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ å¾®ä¿¡é…ç½®ï¼š

```env
# å¾®ä¿¡å…¬ä¼—å·é…ç½®
WECHAT_APPID=your_wechat_appid
WECHAT_APPSECRET=your_wechat_appsecret
WECHAT_TOKEN=your_wechat_token
```

### 3. æœåŠ¡å™¨é…ç½®

#### HTTPSè¦æ±‚
å¾®ä¿¡JS-SDKè¦æ±‚å¿…é¡»ä½¿ç”¨HTTPSï¼Œé…ç½®SSLè¯ä¹¦ï¼š

```nginx
server {
    listen 443 ssl;
    server_name your-domain.com;
    
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    
    location / {
        proxy_pass http://127.0.0.1:8081;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## ğŸ”‘ å¾®ä¿¡JS-SDKç­¾åå®ç°

### å®‰è£…ä¾èµ–
```bash
pip install requests hashlib
```

### å®ç°ç­¾åç®—æ³•

```python
import hashlib
import time
import random
import string
import requests

class WechatJSSDK:
    def __init__(self, appid, appsecret):
        self.appid = appid
        self.appsecret = appsecret
        self.access_token = None
        self.jsapi_ticket = None
        
    def get_access_token(self):
        """è·å–access_token"""
        url = f"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid={self.appid}&secret={self.appsecret}"
        response = requests.get(url)
        data = response.json()
        
        if 'access_token' in data:
            self.access_token = data['access_token']
            return True
        return False
    
    def get_jsapi_ticket(self):
        """è·å–jsapi_ticket"""
        if not self.access_token:
            if not self.get_access_token():
                return False
                
        url = f"https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token={self.access_token}&type=jsapi"
        response = requests.get(url)
        data = response.json()
        
        if data.get('errcode') == 0:
            self.jsapi_ticket = data['ticket']
            return True
        return False
    
    def generate_signature(self, url):
        """ç”ŸæˆJS-SDKç­¾å"""
        if not self.jsapi_ticket:
            if not self.get_jsapi_ticket():
                return None
        
        timestamp = int(time.time())
        noncestr = ''.join(random.choices(string.ascii_letters + string.digits, k=16))
        
        # æ„å»ºç­¾åå­—ç¬¦ä¸²
        sign_str = f"jsapi_ticket={self.jsapi_ticket}&noncestr={noncestr}&timestamp={timestamp}&url={url}"
        
        # SHA1åŠ å¯†
        signature = hashlib.sha1(sign_str.encode('utf-8')).hexdigest()
        
        return {
            'appId': self.appid,
            'timestamp': timestamp,
            'nonceStr': noncestr,
            'signature': signature
        }
```

### æ›´æ–°web_server.py

```python
# åœ¨web_server.pyä¸­æ·»åŠ 
from wechat_sdk import WechatJSSDK

# åˆå§‹åŒ–å¾®ä¿¡SDK
wechat_sdk = WechatJSSDK(
    appid=os.getenv('WECHAT_APPID'),
    appsecret=os.getenv('WECHAT_APPSECRET')
)

@app.route('/api/wechat/config', methods=['POST'])
def wechat_config():
    """è·å–å¾®ä¿¡JS-SDKé…ç½®"""
    try:
        data = request.get_json()
        url = data.get('url', '')
        
        # ç”Ÿæˆç­¾å
        config = wechat_sdk.generate_signature(url)
        
        if config:
            return jsonify({
                'success': True,
                'data': config
            })
        else:
            return jsonify({
                'success': False,
                'message': 'å¾®ä¿¡é…ç½®ç”Ÿæˆå¤±è´¥'
            }), 500
            
    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'å¾®ä¿¡é…ç½®è·å–å¤±è´¥: {str(e)}'
        }), 500
```

## ğŸ“± å¾®ä¿¡å›¾ç‰‡ä¸Šä¼ å®ç°

### å¤„ç†å¾®ä¿¡localId

```python
def handle_wechat_upload(local_id):
    """å¤„ç†å¾®ä¿¡localIdä¸Šä¼ """
    try:
        # 1. è·å–access_token
        if not wechat_sdk.get_access_token():
            raise Exception("è·å–å¾®ä¿¡access_tokenå¤±è´¥")
        
        # 2. ä¸‹è½½å¾®ä¿¡åª’ä½“æ–‡ä»¶
        media_url = f"https://api.weixin.qq.com/cgi-bin/media/get?access_token={wechat_sdk.access_token}&media_id={local_id}"
        
        response = requests.get(media_url)
        if response.status_code != 200:
            raise Exception("ä¸‹è½½å¾®ä¿¡åª’ä½“æ–‡ä»¶å¤±è´¥")
        
        # 3. ä¿å­˜ä¸´æ—¶æ–‡ä»¶
        timestamp = int(time.time())
        temp_filename = f"wechat_{timestamp}_{uuid.uuid4().hex[:8]}.jpg"
        temp_path = Path(UPLOAD_FOLDER) / temp_filename
        
        with open(temp_path, 'wb') as f:
            f.write(response.content)
        
        # 4. ä¸Šä¼ åˆ°OSS
        if oss_uploader:
            oss_url = oss_uploader.upload_file(temp_path, f"face_fusion/user_images/{temp_filename}")
            
            # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
            temp_path.unlink()
            
            if oss_url:
                return jsonify({
                    'success': True,
                    'url': oss_url,
                    'message': 'å¾®ä¿¡å›¾ç‰‡ä¸Šä¼ æˆåŠŸ'
                })
        
        raise Exception("OSSä¸Šä¼ å¤±è´¥")
        
    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'å¾®ä¿¡ä¸Šä¼ å¤„ç†å¤±è´¥: {str(e)}'
        }), 500
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. åŸŸåå’ŒSSLé…ç½®
```bash
# ç”³è¯·SSLè¯ä¹¦ (Let's Encryptå…è´¹è¯ä¹¦)
sudo certbot --nginx -d your-domain.com
```

### 2. å¾®ä¿¡å…¬ä¼—å·é…ç½®
1. é…ç½®JSæ¥å£å®‰å…¨åŸŸå: `your-domain.com`
2. ä¸Šä¼ éªŒè¯æ–‡ä»¶åˆ°æœåŠ¡å™¨æ ¹ç›®å½•
3. è·å–AppIDå’ŒAppSecret

### 3. å¯åŠ¨æœåŠ¡
```bash
# é…ç½®ç¯å¢ƒå˜é‡
export WECHAT_APPID=your_appid
export WECHAT_APPSECRET=your_appsecret

# å¯åŠ¨æœåŠ¡
python web_server.py
```

### 4. è®¿é—®æµ‹è¯•
- å¾®ä¿¡ç‰ˆé¡µé¢: `https://your-domain.com/fanyi-wechat?template=1`
- å¿…é¡»åœ¨å¾®ä¿¡å†…ç½®æµè§ˆå™¨ä¸­æ‰“å¼€

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **åŸŸåè¦æ±‚**: å¿…é¡»æ˜¯å·²å¤‡æ¡ˆçš„åŸŸåï¼Œæ”¯æŒHTTPS
2. **å¾®ä¿¡ç¯å¢ƒ**: åªèƒ½åœ¨å¾®ä¿¡å†…ç½®æµè§ˆå™¨ä¸­ä½¿ç”¨
3. **æƒé™ç”³è¯·**: éœ€è¦åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°ç”³è¯·ç›¸å…³æ¥å£æƒé™
4. **è°ƒè¯•æ¨¡å¼**: å¼€å‘æ—¶å¯ä»¥å¼€å¯debugæ¨¡å¼æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
5. **ç¼“å­˜é—®é¢˜**: å¾®ä¿¡ä¼šç¼“å­˜JSæ–‡ä»¶ï¼Œæ›´æ–°åå¯èƒ½éœ€è¦æ¸…é™¤ç¼“å­˜

## ğŸ” å¸¸è§é—®é¢˜

### Q: æç¤º"config:invalid signature"
A: æ£€æŸ¥ç­¾åç®—æ³•å®ç°ï¼Œç¡®ä¿URLå‚æ•°æ­£ç¡®

### Q: æ— æ³•è°ƒç”¨æ‘„åƒå¤´
A: ç¡®ä¿åœ¨HTTPSç¯å¢ƒä¸‹ï¼Œä¸”åœ¨å¾®ä¿¡å†…ç½®æµè§ˆå™¨ä¸­

### Q: å›¾ç‰‡ä¸Šä¼ å¤±è´¥
A: æ£€æŸ¥access_tokenæ˜¯å¦æœ‰æ•ˆï¼Œmedia_idæ˜¯å¦æ­£ç¡®

### Q: åˆ†äº«åŠŸèƒ½ä¸ç”Ÿæ•ˆ
A: ç¡®ä¿é…ç½®äº†æ­£ç¡®çš„åˆ†äº«å‚æ•°ï¼Œä¸”åœ¨å¾®ä¿¡ç¯å¢ƒä¸­

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚éœ€å¸®åŠ©ï¼Œè¯·å‚è€ƒï¼š
- [å¾®ä¿¡JS-SDKå®˜æ–¹æ–‡æ¡£](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html)
- [å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/)
- é¡¹ç›®README.mdæ–‡æ¡£
