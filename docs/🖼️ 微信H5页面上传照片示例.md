# ğŸ–¼ï¸ å‘¨ç¹æ¼ªäººè„¸èåˆ - å¾®ä¿¡H5ç‰ˆæœ¬

åŸºäºå¾®ä¿¡JS-SDKå®ç°çš„äººè„¸èåˆH5åº”ç”¨ï¼Œæ”¯æŒå¾®ä¿¡å†…æ‹ç…§ä¸Šä¼ ã€AIäººè„¸èåˆã€ç»“æœåˆ†äº«åˆ°æœ‹å‹åœˆç­‰åŠŸèƒ½ã€‚

## ğŸ­ åŠŸèƒ½ç‰¹è‰²

- **å¾®ä¿¡åŸç”Ÿæ‹ç…§** - ä½¿ç”¨å¾®ä¿¡JS-SDKè°ƒç”¨æ‘„åƒå¤´
- **AIäººè„¸èåˆ** - ä¸å‘¨ç¹æ¼ªå®šå¦†ç…§è¿›è¡ŒçœŸå®èåˆ
- **æœ‹å‹åœˆåˆ†äº«** - ä¸€é”®åˆ†äº«èåˆç»“æœåˆ°æœ‹å‹åœˆ
- **iOS/Androidå…¼å®¹** - å®Œç¾é€‚é…ä¸åŒè®¾å¤‡

## ğŸ“± å®Œæ•´å®ç°ä»£ç 

```
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¾®ä¿¡H5ç…§ç‰‡ä¸Šä¼ ç¤ºä¾‹</title>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .content {
            padding: 20px;
        }
        
        .upload-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .preview-area {
            margin-top: 20px;
        }
        
        .preview-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        
        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #ff4757;
        }
        
        .status-message {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            min-height: 20px;
            padding: 8px;
            border-radius: 4px;
        }
        
        .success {
            color: #27ae60;
            background-color: #e8f7f0;
        }
        
        .error {
            color: #e74c3c;
            background-color: #fdedec;
        }
        
        .progress-bar {
            height: 6px;
            background: #f1f1f1;
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 0;
            color: #999;
        }
        
        .empty-state i {
            font-size: 40px;
            margin-bottom: 10px;
            display: block;
            color: #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>å¾®ä¿¡ç…§ç‰‡ä¸Šä¼ ç¤ºä¾‹</h1>
            <p>é€‰æ‹©æˆ–æ‹æ‘„ç…§ç‰‡å¹¶ä¸Šä¼ åˆ°æœåŠ¡å™¨</p>
        </div>
        
        <div class="content">
            <button class="upload-btn" id="uploadBtn">
                <i class="fas fa-camera"></i> é€‰æ‹©æˆ–æ‹æ‘„ç…§ç‰‡
            </button>
            
            <div class="preview-area">
                <div class="preview-title">ç…§ç‰‡é¢„è§ˆ</div>
                <div class="preview-container" id="previewContainer">
                    <div class="empty-state" id="emptyState">
                        <i class="fas fa-images"></i>
                        <div>æš‚æ— ç…§ç‰‡ï¼Œè¯·é€‰æ‹©æˆ–æ‹æ‘„ç…§ç‰‡</div>
                    </div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
            
            <div class="status-message" id="statusMessage"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const uploadBtn = document.getElementById('uploadBtn');
            const previewContainer = document.getElementById('previewContainer');
            const emptyState = document.getElementById('emptyState');
            const statusMessage = document.getElementById('statusMessage');
            const progressBar = document.getElementById('progressBar');
            
            let selectedFiles = [];
            
            // åˆå§‹åŒ–å¾®ä¿¡JS-SDKé…ç½®
            function initWxConfig() {
                // æ³¨æ„ï¼šè¿™é‡Œçš„å‚æ•°åº”è¯¥é€šè¿‡AJAXä»ä½ çš„åç«¯è·å–
                // ä»¥ä¸‹ä¸ºç¤ºä¾‹å€¼ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦æ›¿æ¢ä¸ºåç«¯ç”Ÿæˆçš„æ­£ç¡®å‚æ•°
                wx.config({
                    debug: false, // ç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­è°ƒè¯•æ¨¡å¼
                    appId: 'ä½ çš„å…¬ä¼—å·AppId', // å¿…å¡«ï¼Œå…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†
                    timestamp: 0, // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„æ—¶é—´æˆ³
                    nonceStr: '', // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„éšæœºä¸²
                    signature: '', // å¿…å¡«ï¼Œç­¾å
                    jsApiList: [ // å¿…å¡«ï¼Œéœ€è¦ä½¿ç”¨çš„JSæ¥å£åˆ—è¡¨
                        'chooseImage',
                        'previewImage',
                        'uploadImage',
                        'getLocalImgData'
                    ]
                });
                
                wx.ready(function() {
                    console.log('å¾®ä¿¡JS-SDKåˆå§‹åŒ–æˆåŠŸ');
                    statusMessage.textContent = 'åˆå§‹åŒ–æˆåŠŸï¼Œå¯ä»¥ä¸Šä¼ ç…§ç‰‡äº†';
                    statusMessage.className = 'status-message success';
                });
                
                wx.error(function(res) {
                    console.error('å¾®ä¿¡JS-SDKåˆå§‹åŒ–å¤±è´¥', res);
                    statusMessage.textContent = 'åˆå§‹åŒ–å¤±è´¥: ' + JSON.stringify(res);
                    statusMessage.className = 'status-message error';
                });
            }
            
            // é€‰æ‹©å›¾ç‰‡
            function chooseImage() {
                wx.chooseImage({
                    count: 9, // æœ€å¤šå¯é€‰æ‹©9å¼ å›¾ç‰‡
                    sizeType: ['original', 'compressed'], // å¯ä»¥æŒ‡å®šæ˜¯åŸå›¾è¿˜æ˜¯å‹ç¼©å›¾
                    sourceType: ['album', 'camera'], // å¯ä»¥æŒ‡å®šæ¥æºæ˜¯ç›¸å†Œè¿˜æ˜¯ç›¸æœº
                    success: function(res) {
                        const localIds = res.localIds; // è¿”å›é€‰å®šç…§ç‰‡çš„æœ¬åœ°IDåˆ—è¡¨
                        emptyState.style.display = 'none';
                        
                        // å¤„ç†iOS WKWebViewå…¼å®¹æ€§é—®é¢˜
                        if (isIOS()) {
                            processIOSImages(localIds);
                        } else {
                            processAndroidImages(localIds);
                        }
                    },
                    fail: function(res) {
                        statusMessage.textContent = 'é€‰æ‹©å›¾ç‰‡å¤±è´¥: ' + JSON.stringify(res);
                        statusMessage.className = 'status-message error';
                    }
                });
            }
            
            // å¤„ç†iOSå›¾ç‰‡
            function processIOSImages(localIds) {
                localIds.forEach(function(localId, index) {
                    wx.getLocalImgData({
                        localId: localId,
                        success: function(res) {
                            let localData = res.localData;
                            
                            // å¤„ç†iOSè¿”å›çš„æ•°æ®æ ¼å¼
                            if (localData.indexOf('data:image') !== 0) {
                                localData = 'data:image/jpeg;base64,' + localData;
                            }
                            
                            // æ›¿æ¢iOSç‰¹æœ‰çš„å›¾ç‰‡æ ¼å¼
                            localData = localData.replace('data:image/jgp', 'data:image/jpeg');
                            
                            createPreviewItem(localData, index);
                            selectedFiles.push(localData);
                        },
                        fail: function(res) {
                            statusMessage.textContent = 'è·å–å›¾ç‰‡æ•°æ®å¤±è´¥: ' + JSON.stringify(res);
                            statusMessage.className = 'status-message error';
                        }
                    });
                });
            }
            
            // å¤„ç†Androidå›¾ç‰‡
            function processAndroidImages(localIds) {
                localIds.forEach(function(localId, index) {
                    createPreviewItem(localId, index);
                    selectedFiles.push(localId);
                });
            }
            
            // åˆ›å»ºé¢„è§ˆé¡¹
            function createPreviewItem(src, index) {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.innerHTML = `
                    <img src="${src}" class="preview-img" alt="é¢„è§ˆå›¾ç‰‡">
                    <button class="remove-btn" data-index="${index}">Ã—</button>
                `;
                
                previewContainer.appendChild(previewItem);
                
                // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶
                const removeBtn = previewItem.querySelector('.remove-btn');
                removeBtn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    selectedFiles.splice(index, 1);
                    previewContainer.removeChild(previewItem);
                    
                    if (selectedFiles.length === 0) {
                        emptyState.style.display = 'block';
                    }
                    
                    // æ›´æ–°æ‰€æœ‰åˆ é™¤æŒ‰é’®çš„ç´¢å¼•
                    const allRemoveBtns = document.querySelectorAll('.remove-btn');
                    allRemoveBtns.forEach((btn, i) => {
                        btn.setAttribute('data-index', i);
                    });
                });
            }
            
            // æ£€æµ‹iOSè®¾å¤‡
            function isIOS() {
                return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            }
            
            // ä¸Šä¼ å›¾ç‰‡åˆ°å¾®ä¿¡æœåŠ¡å™¨
            function uploadImages() {
                if (selectedFiles.length === 0) {
                    statusMessage.textContent = 'è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡';
                    statusMessage.className = 'status-message error';
                    return;
                }
                
                statusMessage.textContent = 'å¼€å§‹ä¸Šä¼ å›¾ç‰‡...';
                statusMessage.className = 'status-message';
                
                // é€’å½’ä¸Šä¼ æ‰€æœ‰å›¾ç‰‡
                uploadNextImage(0);
            }
            
            function uploadNextImage(index) {
                if (index >= selectedFiles.length) {
                    statusMessage.textContent = 'æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ å®Œæˆ!';
                    statusMessage.className = 'status-message success';
                    progressBar.style.width = '100%';
                    return;
                }
                
                // æ›´æ–°è¿›åº¦æ¡
                progressBar.style.width = ((index / selectedFiles.length) * 100) + '%';
                
                wx.uploadImage({
                    localId: selectedFiles[index],
                    isShowProgressTips: 1,
                    success: function(res) {
                        const serverId = res.serverId; // è¿”å›å›¾ç‰‡çš„æœåŠ¡å™¨ç«¯ID
                        
                        // å°†serverIdå‘é€åˆ°ä½ çš„åç«¯æœåŠ¡å™¨
                        // åç«¯éœ€è¦è°ƒç”¨å¾®ä¿¡APIä¸‹è½½å›¾ç‰‡å¹¶ä¿å­˜
                        fetch('/your-upload-endpoint', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                serverId: serverId,
                                index: index
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                statusMessage.textContent = `å›¾ç‰‡ ${index + 1}/${selectedFiles.length} ä¸Šä¼ æˆåŠŸ`;
                                statusMessage.className = 'status-message success';
                                
                                // ä¸Šä¼ ä¸‹ä¸€å¼ å›¾ç‰‡
                                setTimeout(() => {
                                    uploadNextImage(index + 1);
                                }, 300);
                            } else {
                                statusMessage.textContent = `å›¾ç‰‡ ${index + 1} ä¸Šä¼ å¤±è´¥: ${data.message}`;
                                statusMessage.className = 'status-message error';
                            }
                        })
                        .catch(error => {
                            statusMessage.textContent = `å›¾ç‰‡ ${index + 1} ä¸Šä¼ å¤±è´¥: ${error.message}`;
                            statusMessage.className = 'status-message error';
                        });
                    },
                    fail: function(res) {
                        statusMessage.textContent = `å›¾ç‰‡ ${index + 1} ä¸Šä¼ å¤±è´¥: ${JSON.stringify(res)}`;
                        statusMessage.className = 'status-message error';
                    }
                });
            }
            
            // åˆå§‹åŒ–
            initWxConfig();
            
            // ç»‘å®šä¸Šä¼ æŒ‰é’®äº‹ä»¶
            uploadBtn.addEventListener('click', function() {
                chooseImage();
            });
        });
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</body>
</html>
```



## âš ï¸ å®ç°å‰çš„å¿…è¦æ¡ä»¶

åœ¨ä½¿ç”¨ä¸Šè¿°ä»£ç å‰ï¼Œä½ éœ€è¦å®Œæˆä»¥ä¸‹å‡†å¤‡å·¥ä½œï¼š

1. **å…¬ä¼—å·é…ç½®**ï¼š
   - æœ‰ä¸€ä¸ªå·²è®¤è¯çš„å¾®ä¿¡å…¬ä¼—å·
   - åœ¨å…¬ä¼—å·åå°è®¾ç½®"JSæ¥å£å®‰å…¨åŸŸå"
   - ä¸‹è½½éªŒè¯æ–‡ä»¶å¹¶æ”¾ç½®åœ¨ä½ çš„æœåŠ¡å™¨æ ¹ç›®å½•
2. **åç«¯æ”¯æŒ**ï¼š
   - å®ç°ç”Ÿæˆå¾®ä¿¡JS-SDKé…ç½®å‚æ•°çš„æ¥å£ï¼ˆappIdã€timestampã€nonceStrã€signatureï¼‰
   - å®ç°æ¥æ”¶serverIdå¹¶è°ƒç”¨å¾®ä¿¡APIä¸‹è½½å›¾ç‰‡çš„æ¥å£
3. **æœåŠ¡å™¨è¦æ±‚**ï¼š
   - æœåŠ¡å™¨åŸŸåå¿…é¡»å·²å®ŒæˆICPå¤‡æ¡ˆ
   - æœåŠ¡å™¨å¿…é¡»æ”¯æŒHTTPSï¼ˆå¾®ä¿¡è¦æ±‚ï¼‰

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½è¯´æ˜

1. **å¾®ä¿¡JS-SDKåˆå§‹åŒ–**ï¼šé…ç½®å¾®ä¿¡JS-SDKä»¥ä¾¿è°ƒç”¨å¾®ä¿¡æä¾›çš„æ¥å£ã€‚
2. **å›¾ç‰‡é€‰æ‹©**ï¼šä½¿ç”¨`wx.chooseImage`æ¥å£è®©ç”¨æˆ·ä»ç›¸å†Œé€‰æ‹©æˆ–æ‹ç…§ã€‚
3. **å¹³å°å…¼å®¹å¤„ç†**ï¼šåŒºåˆ†å¤„ç†iOSå’ŒAndroidè®¾å¤‡çš„å›¾ç‰‡æ•°æ®è·å–æ–¹å¼ã€‚
4. **å›¾ç‰‡é¢„è§ˆ**ï¼šåœ¨é¡µé¢ä¸Šæ˜¾ç¤ºç”¨æˆ·é€‰æ‹©çš„å›¾ç‰‡ã€‚
5. **å›¾ç‰‡ä¸Šä¼ **ï¼šä½¿ç”¨`wx.uploadImage`å°†å›¾ç‰‡ä¸Šä¼ åˆ°å¾®ä¿¡æœåŠ¡å™¨ï¼Œè·å–serverIdã€‚
6. **æœåŠ¡å™¨ä¿å­˜**ï¼šå°†serverIdå‘é€åˆ°ä½ çš„åç«¯æœåŠ¡å™¨ï¼Œåç«¯è°ƒç”¨å¾®ä¿¡APIä¸‹è½½å¹¶ä¿å­˜å›¾ç‰‡ã€‚

## ğŸ’¡ æ³¨æ„äº‹é¡¹

1. **æƒé™é™åˆ¶**ï¼šå¿…é¡»åœ¨å¾®ä¿¡å†…ç½®æµè§ˆå™¨ä¸­æ‰“å¼€æ‰èƒ½ä½¿ç”¨è¿™äº›åŠŸèƒ½ã€‚
2. **æ•°é‡é™åˆ¶**ï¼šä¸€æ¬¡æœ€å¤šåªèƒ½é€‰æ‹©9å¼ å›¾ç‰‡ã€‚
3. **æœ‰æ•ˆæœŸ**ï¼šå¾®ä¿¡æœåŠ¡å™¨ä¸Šçš„å›¾ç‰‡ä»…ä¿å­˜3å¤©ï¼Œéœ€è¦åŠæ—¶ä¸‹è½½åˆ°è‡ªå·±çš„æœåŠ¡å™¨ã€‚
4. **iOSå…¼å®¹æ€§**ï¼šiOSè®¾å¤‡éœ€è¦ä½¿ç”¨`getLocalImgData`æ¥å£è·å–å›¾ç‰‡æ•°æ®ã€‚
5. **å®‰å…¨åŸŸå**ï¼šæ‰€æœ‰æ“ä½œå¿…é¡»åœ¨å·²é…ç½®çš„JSæ¥å£å®‰å…¨åŸŸåä¸‹è¿›è¡Œã€‚